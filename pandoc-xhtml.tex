\startxmlsetups xml:pandoc
    \xmlsetsetup{\xmldocument}{*}{-}
    \xmlsetsetup{\xmldocument}{html|body|head|div|h1|h2|h3|h4|h5|h6|p|blockquote|span|em|q|b|pre|code|strong|a|ul|ol|li|hr|br|sup|sub}{xml:*}
    \xmlsetsetup{\xmldocument}{(div|span)[@lang]}{xml:lang}
    \xmlsetsetup{\xmldocument}{[contains(@class,'part')]/h1}{xml:part}
    \xmlsetsetup{\xmldocument}{[contains(@class,'part')]/[contains(@class,'level2')]/h2}{xml:h1}
    \xmlsetsetup{\xmldocument}{[contains(@class,'hidden')]/h1}{xml:hidden}
    \xmlsetsetup{\xmldocument}{[@id='header']}{xml:titlepage}
    \xmlsetsetup{\xmldocument}{[@class='rights']}{xml:rights}
    \xmlsetsetup{\xmldocument}{[@id='dedication']}{xml:dedication}
    \xmlsetsetup{\xmldocument}{[@id='epigraph']}{xml:epigraph}
    \xmlsetsetup{\xmldocument}{[@id='frontmatter']}{xml:frontmatter}
    \xmlsetsetup{\xmldocument}{[@id='bodymatter']}{xml:bodymatter}
    \xmlsetsetup{\xmldocument}{[@id='colophon']}{xml:colophon}
    \xmlsetsetup{\xmldocument}{[@class='signature-date']}{xml:signaturedate}
    \xmlsetsetup{\xmldocument}{span[@label]}{xml:logo}
    \xmlsetsetup{\xmldocument}{a[@class='footnoteRef']}{xml:footnote:ref}
    \xmlsetsetup{\xmldocument}{div[@class='footnotes']}{}
    \xmlsetsetup{\xmldocument}{a[@class='uri']}{xml:autolink}
    \xmlsetsetup{\xmldocument}{a[@class='footnoteBack']}{}
    \xmlsetsetup{\xmldocument}{a[text()='â†©']}{}
    \xmlsetsetup{\xmldocument}{ol[@style='list-style-type: decimal']}{xml:ol}
    \xmlsetsetup{\xmldocument}{ol[@style='list-style-type: lower-alpha']}{xml:lalist}
    \xmlsetsetup{\xmldocument}{ol[@style='list-style-type: upper-alpha']}{xml:ualist}
    \xmlsetsetup{\xmldocument}{ol[@style='list-style-type: lower-roman']}{xml:lrlist}
    \xmlsetsetup{\xmldocument}{ol[@style='list-style-type: upper-roman']}{xml:urlist}
\stopxmlsetups

\xmlregistersetup{xml:pandoc}

\startxmlsetups xml:html
    \mainlanguage[\xmlatt{#1}{lang}]
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:body
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:head
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:titlepage
    \startcoverpagemakeup
        \setupbodyfont[svb]
        {\setupbodyfont[25pt]\sc \xmltext{#1}{h2[@class='author']}}
        \vfill
        \scale[width=\textwidth]{\bf \xmltext{#1}{h1[@class='title']}}

        \startalign [flushright]
        \dontleavehmode\scale[width=.75\textwidth]{\it \xmltext{#1}{h1[@class='subtitle']}}
        \stopalign
        \vfill
        \startalign[center]
        \dontleavehmode\externalfigure[simpleoldtypewriter][scale=400]
        \stopalign
        \vfill
        \startalign[flushright]
        {\setupbodyfont[25pt]\xmltext{#1}{p[@class='publisher']}}
        \stopalign
    \stopcoverpagemakeup

    \starttitlepagemakeup
        \mbox{}\vfill

        {\itd \xmltext{#1}{h1[@class='title']}\par}\blank[big]
        {\itb\setupinterlinespace \xmltext{#1}{h1[@class='subtitle']}\par}\blank[3*big]
        {\sc \xmltext{#1}{h2[@class='author']}}

        \vfill
        \xmltext{#1}{h3[@class='date']}
        \vfill
        \xmltext{#1}{p[@class='publisher']}
    \stoptitlepagemakeup
\stopxmlsetups

\startxmlsetups xml:rights
    \startcopyrightmakeup
    \xmlflush{#1}
    \stopcopyrightmakeup
\stopxmlsetups

\startxmlsetups xml:dedication
    \startdedicationmakeup
    \xmlflush{#1}
    \stopdedicationmakeup
\stopxmlsetups

\startxmlsetups xml:epigraph
    \startepigraphmakeup
    \xmlflush{#1}
    \stopepigraphmakeup
\stopxmlsetups

\startxmlsetups xml:frontmatter
    \def\TOC_Title{\startmode[*en]\title{Contents}\stopmode\startmode[*es]\title{Sumario}\stopmode\startmode[*deo]\title{Inhalt}\stopmode\startmode[*de]\title{Inhalt}\stopmode}
    \startfirstmatter
    \TOC_Title\placelist[part,chapter]
    \stopfirstmatter

    \startfrontmatter
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:bodymatter
    \stopfrontmatter

    \startbodymatter
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:colophon
    \stopbodymatter
    \startbackmatter
    \startnotmode[without-notes]
    \def\Footnotes_Title{\startmode[*en]\chapter{Notes}\stopmode\startmode[*es]\chapter{Notas}\stopmode\startmode[*deo]\chapter{Notizen}\stopmode\startmode[*de]\chapter{Notizen}\stopmode\startmode[*fr]\chapter{Notes}\stopmode}
    \Footnotes_Title\placefootnotes
    \stopnotmode

    \startcolophonmakeup
    \xmlflush{#1}
    \stopcolophonmakeup
    \stopbackmatter
\stopxmlsetups

\startxmlsetups xml:div
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:lang
     \begingroup
         \language[\xmlatt{#1}{lang}]
         \xmlsetup{#1}{xml:\xmltag{#1}}
     \endgroup
\stopxmlsetups

\startxmlsetups xml:part
    \part{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:h1
    \chapter{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:h2
    \section{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:h3
    \subsection{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:h4
    \subsubsection{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:h5
    \subsubsubsection{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:h6
    \subsubsubsubsection{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:p
    \xmldoifnotselfempty {#1} {
        \dontleavehmode
        \ignorespaces
        \xmlflush{#1}
        \removeunwantedspaces
    }
    \par
\stopxmlsetups

\startxmlsetups xml:blockquote
    \startnarrow\xmlflush{#1}\stopnarrow
\stopxmlsetups

\startxmlsetups xml:signaturedate
    \startalign[flushright]
    \xmlflush{#1}
    \stopalign
\stopxmlsetups

\startxmlsetups xml:span
   \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:em
    \begingroup\em \xmlflush{#1}\endgroup
\stopxmlsetups

\startxmlsetups xml:q
    \quotation{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:b
    \begingroup\bf\xmlflush{#1}\endgroup
\stopxmlsetups

\startxmlsetups xml:pre
    %~ \xmldisplayverbatim{#1}
    \xmlflush{#1}\par
\stopxmlsetups

\startxmlsetups xml:code
    \begingroup\tt\xmlflush{#1}\endgroup
     %~ \xmlinlineverbatim{#1}
\stopxmlsetups

\startxmlsetups xml:strong
    \begingroup\bf\xmlflush{#1}\endgroup
\stopxmlsetups

\startxmlsetups xml:a
    \href{\xmlatt{#1}{href}}{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:autolink
    \url{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:footnote:set
     \startfootnote
         \xmlflush{#1}
     \stopfootnote
\stopxmlsetups

\startluacode
     local gsub = string.gsub
     function xml.expressions.idstring(str)
         return type(str) == "string" and gsub(str,"^#","") or ""
     end
\stopluacode

\startxmlsetups xml:footnote:ref
    \xmlfilter{main}{div[@class='footnotes']/ol/li[@id=idstring('\xmlatt{#1}{href}')]/command(xml:footnote:set)}
\stopxmlsetups



\startxmlsetups xml:ol
\doifnumberelse{\xmlatt{#1}{start}}
    {\startitemize[n][start=\xmlatt{#1}{start}]
        \xmlflush{#1}
    \stopitemize}
    {\startitemize[n]
        \xmlflush{#1}
    \stopitemize}
\stopxmlsetups

\startxmlsetups xml:lalist
\doifnumberelse{\xmlatt{#1}{start}}
    {\startitemize[a][start=\xmlatt{#1}{start}]
        \xmlflush{#1}
    \stopitemize}
    {\startitemize[a]
        \xmlflush{#1}
    \stopitemize}
\stopxmlsetups

\startxmlsetups xml:ualist
\doifnumberelse{\xmlatt{#1}{start}}
    {\startitemize[A][start=\xmlatt{#1}{start}]
        \xmlflush{#1}
    \stopitemize}
    {\startitemize[A]
        \xmlflush{#1}
    \stopitemize}
\stopxmlsetups

\startxmlsetups xml:lrlist
\doifnumberelse{\xmlatt{#1}{start}}
    {\startitemize[r][start=\xmlatt{#1}{start}]
        \xmlflush{#1}
    \stopitemize}
    {\startitemize[r]
        \xmlflush{#1}
    \stopitemize}
\stopxmlsetups

\startxmlsetups xml:urlist
\doifnumberelse{\xmlatt{#1}{start}}
    {\startitemize[R][start=\xmlatt{#1}{start}]
        \xmlflush{#1}
    \stopitemize}
    {\startitemize[R]
        \xmlflush{#1}
    \stopitemize}
\stopxmlsetups

\startxmlsetups xml:ul
    \startitemize
        \xmlflush{#1}
    \stopitemize
\stopxmlsetups

\startxmlsetups xml:li
    \startitem
        \xmlflush{#1}
    \stopitem
\stopxmlsetups

\startxmlsetups xml:hr
    \blank\hrule\blank
\stopxmlsetups

\startxmlsetups xml:br
     \\
\stopxmlsetups

\startxmlsetups xml:sup
     \high{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:sub
     \low{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:logo
    \uppercasestring\xmlatt{#1}{label}\xmlatt{#1}{name}\to\ascii
    \ifx\ascii\empty\else\getvalue{\ascii}\fi
\stopxmlsetups

\def\url#1{\begingroup\tt\goto{\hyphenatedurl{#1}}[url(#1)]\endgroup}
\def\href#1#2{\goto{#2} [url(#1)]}

\installlanguage [af-ZA] [af]
\installlanguage [ar-DZ] [ar-dz]
\installlanguage [ar-IQ] [ar-iq]
\installlanguage [ar-JO] [ar-jo]
\installlanguage [ar-LB] [ar-lb]
\installlanguage [ar-MA] [ar-ma]
\installlanguage [ar-SY] [ar-sy]
\installlanguage [bg-BG] [bg]
\installlanguage [ca-ES] [ca]
\installlanguage [cy-UK] [cy]
\installlanguage [cz-CZ] [cz]
\installlanguage [da-DK] [da]
\installlanguage [de-1901] [deo]
\installlanguage [de-AT] [de-at]
\installlanguage [de-CH] [de-ch]
\installlanguage [de-DE] [de-de]
\installlanguage [el] [gr]
\installlanguage [en-UK] [uk]
\installlanguage [en-US] [en]
\installlanguage [es-ES] [es]
\installlanguage [et-EE] [et]
\installlanguage [eu-ES] [eu]
\installlanguage [fi-FI] [fi]
\installlanguage [fr-CA] [fr]
\installlanguage [fr-FR] [fr]
\installlanguage [grc] [agr]
\installlanguage [he] [il]
\installlanguage [he-IL] [il]
\installlanguage [hr-HR] [hr]
\installlanguage [hu-HU] [hu]
\installlanguage [is-IS] [is]
\installlanguage [it-IT] [it]
\installlanguage [jp] [ja]
\installlanguage [jp-JP] [ja]
\installlanguage [nb-NO] [nb]
\installlanguage [nl-NL] [nl]
\installlanguage [nn-NO] [nn]
\installlanguage [no-NO] [no]
\installlanguage [pl-PL] [pl]
\installlanguage [pt-BR] [pt]
\installlanguage [pt-PT] [pt]
\installlanguage [ro-RO] [ro]
\installlanguage [ru-RU] [ru]
\installlanguage [sk-SK] [sk]
\installlanguage [sl-SL] [sl]
\installlanguage [sv-SE] [sv]
\installlanguage [tr-TR] [tr]
\installlanguage [uk] [ua]
\installlanguage [uk-UA] [ua]
\installlanguage [vi] [vn]
\installlanguage [vi-VN] [vn]
